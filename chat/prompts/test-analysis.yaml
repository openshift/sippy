# Deep dive analysis of a specific test failure
name: test-analysis
description: Analyze why a specific test is failing with detailed failure patterns, recent failures, and potential causes
arguments:
  - name: test_name
    description: Full test name to analyze
    required: true
    type: string
    autocomplete: tests
  - name: release
    description: Release version to analyze
    required: true
    type: string
    autocomplete: releases
  - name: variants
    description: Filter by specific variants (e.g., Platform:gcp, Topology:single)
    required: false
    type: array
    autocomplete: variants
  - name: days
    description: Number of days to look back for analysis
    required: false
    type: string
messages:
  - role: user
    content: |
      Perform a comprehensive failure analysis for the following test by queying the database. Do not use the test details report tool.
      
      **Test:**
      {test_name}

      **Release:**
      {release}

      **Variants:**
      {variants|default:all variants}

      **Time Range:**
      Last {days|default:7} days
      
      Please provide a detailed analysis covering:
      
      ## 1. Test Overview
      - Test name
      - Current statistics (passing/failing/flaking)
      - If variants are specified, focus the analysis on those variants only
      
      ## 2. Recent Failure Analysis
      - How many times has this test failed in the specified time range?
      - What is the failure rate compared to the previous period?
      - Are failures increasing, decreasing, or stable?
      - Use the database to query recent failure statistics
      
      ## 3. Failure Patterns
      - Which jobs is this test failing in most frequently?
      - Are failures concentrated in specific variants (platforms, architectures, topologies)?
      - If specific variants were provided, compare failure rates within those variants
      - Is there a time pattern to the failures (specific time of day, day of week)?
      - Get up to 5 recent failed job run IDs
      
      ## 4. Failure Details
      For up to 3 of the most recent failures:
      - Get a prow job summary to get details about each failed job run
      - Look for common error messages or patterns
      - Check if the same tests are failing together (correlated failures)
      - Use the database to get actual failure output from prow_job_run_test_outputs if available
      
      ## 5. Regression Status
      - Check if there's an open regression for this test using get_test_details_report
      - If a regression exists, provide:
        * Regression ID and when it was opened
        * Current triage status
        * Any linked Jira issues
      
      ## 6. Known Incidents
      - Check if there are any known TRT incidents that might explain these failures
      - Use check_known_incidents to see if this failure is part of a broader issue
      
      ## 7. Similar Failures
      - Are there other tests with similar names or in the same suite failing?
      - Use the database to find tests with similar failure patterns
      
      ## 8. Recommendations
      Based on the analysis, provide:
      - Is this a genuine product bug, infrastructure issue, or test issue?
      - Priority level (how urgently should this be addressed?)
      - Suggested next steps for investigation or resolution
      - Any relevant Jira issues or documentation links
      
      **Important Guidelines:**
      - Provide specific numbers and data points, not vague statements
      - Include links to Prow job runs, TestGrid, or Jira when relevant
      - If you cannot find certain information, say so explicitly
      - Focus on actionable insights that help debug or triage the failure

